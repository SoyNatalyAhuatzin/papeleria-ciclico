<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contador</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600&display=Poppins" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #d7d2cb;
      border: 20px solid #7a8f7a;
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background-color: #ffffff;
      border-bottom: 1px solid #ccc;
      position: relative;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      position: absolute;
      top: 20px;
      right: 20px;
    }
    .user-info img {
      width: 40px;
      height: 40px;
    }
    .user-info span {
      font-size: 16px;
      font-weight: 600;
    }
    .search-bar {
      flex: 1;
      max-width: 450px;
      margin: 0 40px;
      position: relative;
    }
    .search-bar input {
      width: 100%;
      padding: 12px 12px 12px 45px;
      border: 2px solid #000000;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
    }
    .search-bar img {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
    }
    .icons {
      display: flex;
      gap: 20px;
      position: absolute;
      right: 180px;
      top: 25px;
      z-index: 10;
    }
    .icons img {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    .container {
      display: flex;
      flex: 1;
      margin: 30px;
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      align-items: flex-start;
    }
    .menu {
      width: 180px;
      background-color: #d7d2cb;
      padding: 0;
      display: flex;
      flex-direction: column;
      border-right: none;
    }
    .menu-items {
      background-color: #f8f8f8;
      padding: 20px 0;
    }
    .menu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .menu li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      border-bottom: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    .menu li img {
      width: 20px;
      height: 20px;
      display: inline-block;
      flex-shrink: 0;
    }
    .menu li:last-child {
      border-bottom: none;
    }
    .menu li:hover {
      background-color: #e05576;
      color: white;
      border-radius: 4px;
    }
    .menu li.active {
      background-color: #e05576;
      color: white;
      border-radius: 4px;
    }
    .logout-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      border-radius: 8px;
      text-align: center;
      margin: 10px 20px 0 20px;
    }
    .logout-button:hover {
      background-color: #b33c5e;
    }
    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: #ffffff;
      margin: 0;
    }
    .content h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 40px;
      margin: 0 0 10px;
    }
    .content h3 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      margin: 20px 0 10px;
    }
    .content p {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      margin: 5px 0;
    }
    .chart-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px;
      margin: 0 0 10px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chart-title img {
      width: 24px;
      height: 24px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      text-align: center;
    }
    .modal-content h2 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      margin: 0 0 15px;
    }
    .modal-content img {
      width: 40px;
      height: 40px;
      margin-bottom: 10px;
    }
    .modal-content p {
      font-size: 16px;
      margin: 0 0 15px;
    }
    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
      color: #000000;
    }
    .chart-container {
      width: 100%;
      max-width: 650px;
      margin: 20px 0 0 0;
      min-height: 300px;
    }
    .update-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
      border-radius: 8px;
      display: block;
      margin: 10px auto;
    }
    .update-button:hover {
      background-color: #b33c5e;
    }
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 0;
      align-items: start;
    }
    .chart-grid-item {
      grid-column: 1 / 2;
      display: block;
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
    }
    .stock-container {
      grid-column: 2 / 3;
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
      max-width: 650px;
      margin-top: 0;
      display: block;
      max-height: 400px;
      overflow-y: auto;
    }
    .users-table-container, .permisos-table-container, .pagos-table-container {
      grid-column: 1 / 3;
      margin-top: 20px;
      max-width: 100%;
      display: block;
    }
    .error-message {
      color: #e05576;
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    .users-table, .permisos-table, .pagos-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
    }
    .users-table th, .users-table td, .permisos-table th, .permisos-table td, .pagos-table th, .pagos-table td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .users-table th, .permisos-table th, .pagos-table th {
      background-color: #f8f8f8;
      font-weight: 600;
    }
    .users-table tr:nth-child(even), .permisos-table tr:nth-child(even), .pagos-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .delete-icon {
      cursor: pointer;
      width: 20px;
      height: 20px;
      vertical-align: middle;
    }
    .permisos-table .no-permiso {
      color: #e05576;
    }
    .stock-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .stock-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stock-title img {
      width: 24px;
      height: 24px;
    }
    .view-more-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
      border-radius: 8px;
    }
    .view-more-button:hover {
      background-color: #b33c5e;
    }
    .stock-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .stock-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }
    .stock-item div {
      flex: 1;
    }
    .stock-item-name {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 600;
      margin: 0;
    }
    .stock-item-percentage {
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
      color: #555;
      margin: 5px 0 0;
    }
    .stock-error {
      color: #e05576;
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
    }
    .product-card {
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }
    .product-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .product-card p {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      margin: 5px 0;
    }
    .product-card .product-name {
      font-weight: 600;
    }
    .product-card .product-percentage {
      font-size: 12px;
      color: #555;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .action-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      border-radius: 8px;
      margin: 0 25px;
    }
    .action-button:hover {
      background-color: #b33c5e;
    }
    .action-button.active {
      background-color: #b33c5e;
    }
    .modal-content label {
      display: block;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      margin: 10px 0 5px;
      text-align: left;
    }
    .modal-content select, .modal-content input[type="text"], .modal-content input[type="password"], .modal-content input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
    }
    .modal-content input[type="text"], .modal-content input[type="password"], .modal-content input[type="number"] {
      background-color: #f9f9f9;
    }
    .modal-content .radio-group {
      margin: 15px 0;
      text-align: left;
    }
    .modal-content .radio-group label {
      display: inline-block;
      margin-right: 20px;
    }
    .modal-content .radio-group input[type="radio"] {
      margin-right: 5px;
    }
    .modal-content .save-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      border-radius: 8px;
      display: block;
      margin: 20px auto 0;
    }
    .modal-content .save-button:hover {
      background-color: #b33c5e;
    }
    .modal-content .accept-button, .modal-content .cancel-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      border-radius: 8px;
      margin: 10px 5px;
    }
    .modal-content .cancel-button {
      background-color: #ccc;
      color: #000;
    }
    .modal-content .accept-button:hover {
      background-color: #b33c5e;
    }
    .modal-content .cancel-button:hover {
      background-color: #aaa;
    }
    .permisos-table-title, .pagos-table-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 24px;
      margin: 20px 0 10px;
    }
    .permisos-edit-button, .registrar-egreso-button {
      background-color: #e05576;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      border-radius: 8px;
      margin-top: 10px;
    }
    .permisos-edit-button:hover, .registrar-egreso-button:hover {
      background-color: #b33c5e;
    }
    .modal-content .checkbox-group {
      margin: 15px 0;
      text-align: left;
    }
    .modal-content .checkbox-group label {
      display: block;
      margin-bottom: 10px;
    }
    .modal-content .checkbox-group input[type="checkbox"] {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div id="welcomeModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">×</span>
      <img src="https://img.icons8.com/fluent/40/000000/happy.png" alt="Icono">
      <h2>¡Bienvenido contador!</h2>
      <p>Estás en el panel de contador.</p>
    </div>
  </div>
  <div id="productsModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeProductsModal()">×</span>
      <h2>Todos los Productos</h2>
      <div id="productsGrid" class="products-grid"></div>
      <div id="productsError" class="error-message">Error al cargar productos en el modal.</div>
    </div>
  </div>
  <div id="registrarEgresoModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeRegistrarEgresoModal()">×</span>
      <h2>NUEVO EGRESO</h2>
      <label for="egresoMonto">Monto:</label>
      <input type="number" id="egresoMonto" placeholder="Ej. 5000" required>
      <label for="egresoTipo">Concepto:</label>
      <select id="egresoTipo" onchange="updateDestinatarioOptions()">
        <option value="">Seleccionar</option>
        <option value="trabajador">Trabajador</option>
        <option value="proveedor">Proveedor</option>
      </select>
      <label for="egresoDestinatario">Destinatario:</label>
      <select id="egresoDestinatario" disabled>
        <option value="">Seleccione un tipo primero</option>
      </select>
      <label for="egresoServicio">Descripción del Servicio:</label>
      <input type="text" id="egresoServicio" placeholder="Ej. Pago de salario" required>
      <button class="save-button" onclick="saveEgreso()">Guardar</button>
    </div>
  </div>
  <div class="header">
    <div class="search-bar">
      <img src="https://img.icons8.com/ios-filled/20/000000/search--v1.png" alt="Search Icon">
      <input type="text" id="searchInput" placeholder="Buscar productos..." oninput="searchProducts()">
    </div>
    <div class="icons">
      <img src="https://img.icons8.com/ios/24/000000/speech-bubble--v2.png" alt="Messages" onclick="alert('Mensajes no implementados')">
      <img src="https://img.icons8.com/ios/24/000000/bell--v3.png" alt="Notifications" onclick="alert('Notificaciones no implementadas')">
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <img src="https://img.icons8.com/ios-glyphs/40/000000/user--v1.png" alt="User Icon">
    </div>
  </div>
  <div class="container">
    <div class="menu">
      <div class="menu-items">
        <ul>
          <li id="menu-main" onclick="showContent('main')" class="active">
            <img src="https://img.icons8.com/ios/20/000000/home--v1.png" alt="Main Icon">
            Menú Principal
          </li>
          <li id="menu-gestion" onclick="showContent('gestion')">
            <img src="https://img.icons8.com/ios/20/000000/bar-chart.png" alt="Gestion Icon">
            Gestión
          </li>
        </ul>
      </div>
      <button class="logout-button" onclick="logout()">Cerrar Sesión</button>
    </div>
    <div class="content" id="content">
      <h2>Menú Principal</h2>
      <h3>Reportes Contables</h3>
      <div class="content-grid">
        <div class="chart-grid-item">
          <div class="chart-title">
            <img src="https://img.icons8.com/color/24/000000/money-bag.png" alt="Ingresos Icon">
            Ingresos
          </div>
          <p>Total Ingresos: $150,000 MXN</p>
          <p>Ingresos por Ventas: $120,000 MXN</p>
          <p>Ingresos por Servicios: $30,000 MXN</p>
          <button class="update-button" onclick="generateIngresosPDF()">Generar</button>
        </div>
        <div class="stock-container">
          <div class="stock-title">
            <img src="https://img.icons8.com/color/24/000000/banknotes.png" alt="Egresos Icon">
            Egresos
          </div>
          <p>Total Egresos: $80,000 MXN</p>
          <p>Gastos Operativos: $50,000 MXN</p>
          <p>Pagos a Proveedores: $30,000 MXN</p>
          <button class="update-button" onclick="generateEgresosPDF()">Generar</button>
        </div>
        <div class="pagos-table-container">
          <div class="pagos-table-title">Pagos</div>
          <table class="pagos-table" id="pagosTable">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Servicio</th>
                <th>Pago</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button class="registrar-egreso-button" onclick="showRegistrarEgresoModal()">Registrar Egreso</button>
        </div>
      </div>
      <div id="searchResults"></div>
    </div>
  </div>
  <script>
    let pagosChart = null;

    function initializePage() {
      console.log('Inicializando página...');
      const modal = document.getElementById('welcomeModal');
      const userName = document.getElementById('userName');
      if (!modal || !userName) {
        console.error('Elementos no encontrados: modal=', !!modal, 'userName=', !!userName);
        return;
      }
      const urlParams = new URLSearchParams(window.location.search);
      const name = urlParams.get('name') || 'Usuario';
      modal.classList.add('show');
      userName.textContent = decodeURIComponent(name);
      console.log('Modal activada, nombre establecido:', name);
      showContent('main');
    }

    function closeModal() {
      console.log('Cerrando modal de bienvenida...');
      const modal = document.getElementById('welcomeModal');
      if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
        showContent('main');
      } else {
        console.error('Modal no encontrada');
      }
    }

    function showProductsModal() {
      console.log('Mostrando modal de productos...');
      const modal = document.getElementById('productsModal');
      if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
        renderProductsModal();
      } else {
        console.error('Modal de productos no encontrado');
      }
    }

    function closeProductsModal() {
      console.log('Cerrando modal de productos...');
      const modal = document.getElementById('productsModal');
      if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
      } else {
        console.error('Modal no encontrada');
      }
    }

    function showRegistrarEgresoModal() {
      console.log('Mostrando modal de registrar egreso...');
      const modal = document.getElementById('registrarEgresoModal');
      if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.getElementById('egresoMonto').value = '';
        document.getElementById('egresoTipo').value = '';
        document.getElementById('egresoDestinatario').innerHTML = '<option value="">Seleccione un tipo primero</option>';
        document.getElementById('egresoDestinatario').disabled = true;
        document.getElementById('egresoServicio').value = '';
      } else {
        console.error('Modal de registrar egreso no encontrado');
      }
    }

    function closeRegistrarEgresoModal() {
      console.log('Cerrando modal de registrar egreso...');
      const modal = document.getElementById('registrarEgresoModal');
      if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
      } else {
        console.error('Modal no encontrada');
      }
    }

    async function updateDestinatarioOptions() {
      console.log('Actualizando opciones de destinatario...');
      const tipo = document.getElementById('egresoTipo').value;
      const destinatarioSelect = document.getElementById('egresoDestinatario');
      if (!destinatarioSelect) {
        console.error('Select de destinatario no encontrado');
        return;
      }
      destinatarioSelect.innerHTML = '<option value="">Cargando...</option>';
      destinatarioSelect.disabled = false;

      try {
        if (tipo === 'trabajador') {
          const usuarios = await fetchUsuarios();
          destinatarioSelect.innerHTML = '<option value="">Seleccione un trabajador</option>' +
            usuarios.map(u => `<option value="user_${u.usuario_id}">${u.nombre}</option>`).join('');
        } else if (tipo === 'proveedor') {
          const proveedores = await fetchProveedores();
          destinatarioSelect.innerHTML = '<option value="">Seleccione un proveedor</option>' +
            proveedores.map(p => `<option value="prov_${p.proveedor_id}">${p.nombre}</option>`).join('');
        } else {
          destinatarioSelect.innerHTML = '<option value="">Seleccione un tipo primero</option>';
          destinatarioSelect.disabled = true;
        }
        console.log('Opciones de destinatario actualizadas para:', tipo);
      } catch (error) {
        console.error('Error al actualizar destinatarios:', error);
        destinatarioSelect.innerHTML = '<option value="">Error al cargar</option>';
        destinatarioSelect.disabled = true;
      }
    }

    async function fetchUsuarios() {
      console.log('Obteniendo datos de usuarios...');
      try {
        const response = await fetch('/api/usuarios');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Datos de usuarios recibidos:', data);
        if (!data || data.length === 0) throw new Error('No hay datos de usuarios');
        return data.map(item => ({ usuario_id: item.usuario_id, nombre: item.nombre || 'Usuario desconocido' }));
      } catch (error) {
        console.error('Error al obtener datos de usuarios:', error);
        return [
          { usuario_id: 1, nombre: 'Juan Pérez' },
          { usuario_id: 2, nombre: 'María López' },
          { usuario_id: 3, nombre: 'Carlos Gómez' },
          { usuario_id: 4, nombre: 'Ana Martínez' }
        ];
      }
    }

    async function fetchProveedores() {
      console.log('Obteniendo datos de proveedores...');
      try {
        const response = await fetch('/api/proveedores');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Datos de proveedores recibidos:', data);
        if (!data || data.length === 0) throw new Error('No hay datos de proveedores');
        return data.map(item => ({ proveedor_id: item.proveedor_id, nombre: item.nombre || 'Proveedor desconocido' }));
      } catch (error) {
        console.error('Error al obtener datos de proveedores:', error);
        return [
          { proveedor_id: 1, nombre: 'Suministros Papel SA' },
          { proveedor_id: 2, nombre: 'Transportes Rápidos' },
          { proveedor_id: 3, nombre: 'Materiales del Norte' },
          { proveedor_id: 4, nombre: 'Impresoras MX' }
        ];
      }
    }

    async function saveEgreso() {
      console.log('Guardando egreso...');
      const monto = document.getElementById('egresoMonto').value.trim();
      const tipo = document.getElementById('egresoTipo').value;
      const destinatario = document.getElementById('egresoDestinatario').value;
      const servicio = document.getElementById('egresoServicio').value.trim();
      if (!monto || !tipo || !destinatario || !servicio) {
        alert('Por favor, complete todos los campos.');
        console.log('Campos incompletos:', { monto, tipo, destinatario, servicio });
        return;
      }
      const [recipient_type, id] = destinatario.split('_');
      const concepto = tipo === 'trabajador' ? 'Trabajador' : 'Proveedor';
      const destinatarioText = document.getElementById('egresoDestinatario').selectedOptions[0].text;
      try {
        const response = await fetch('/api/egresos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            concepto,
            servicio: `${servicio} (${destinatarioText})`,
            monto,
            recipient_type,
            recipient_id: parseInt(id)
          })
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || 'Unknown error'}`);
        }
        console.log('Egreso registrado exitosamente');
        closeRegistrarEgresoModal();
        renderPagosTable();
      } catch (error) {
        console.error('Error al registrar egreso:', error);
        alert(`Error al registrar egreso: ${error.message}`);
        // Fallback: Agregar localmente para demostración
        const tbody = document.querySelector('#pagosTable tbody');
        if (tbody) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${concepto}</td>
            <td>${servicio} (${destinatarioText})</td>
            <td>$${parseFloat(monto).toLocaleString('es-MX')} MXN</td>
          `;
          tbody.appendChild(row);
        }
        closeRegistrarEgresoModal();
      }
    }

    async function showContent(section) {
      console.log(`Mostrando contenido de sección: ${section}`);
      const content = document.getElementById('content');
      const menuItems = document.querySelectorAll('.menu li');
      if (!content) {
        console.error('Contenedor de contenido no encontrado');
        return;
      }
      menuItems.forEach(item => item.classList.remove('active'));
      document.getElementById(`menu-${section}`)?.classList.add('active');

      if (section === 'main') {
        content.innerHTML = `
          <h2>Menú Principal</h2>
          <h3>Reportes Contables</h3>
          <div class="content-grid">
            <div class="chart-grid-item">
              <div class="chart-title">
                <img src="https://img.icons8.com/color/24/000000/money-bag.png" alt="Ingresos Icon">
                Ingresos
              </div>
              <p>Total Ingresos: $150,000 MXN</p>
              <p>Ingresos por Ventas: $120,000 MXN</p>
              <p>Ingresos por Servicios: $30,000 MXN</p>
              <button class="update-button" onclick="generateIngresosPDF()">Generar</button>
            </div>
            <div class="stock-container">
              <div class="stock-title">
                <img src="https://img.icons8.com/color/24/000000/banknotes.png" alt="Egresos Icon">
                Egresos
              </div>
              <p>Total Egresos: $80,000 MXN</p>
              <p>Gastos Operativos: $50,000 MXN</p>
              <p>Pagos a Proveedores: $30,000 MXN</p>
              <button class="update-button" onclick="generateEgresosPDF()">Generar</button>
            </div>
            <div class="pagos-table-container">
              <div class="pagos-table-title">Pagos</div>
              <table class="pagos-table" id="pagosTable">
                <thead>
                  <tr>
                    <th>Concepto</th>
                    <th>Servicio</th>
                    <th>Pago</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button class="registrar-egreso-button" onclick="showRegistrarEgresoModal()">Registrar Egreso</button>
            </div>
          </div>
          <div id="searchResults"></div>
        `;
        renderPagosTable();
      } else if (section === 'gestion') {
        content.innerHTML = `
          <h2>Gestión</h2>
          <h3>Análisis de Pagos</h3>
          <p>El siguiente gráfico de barras muestra el monto total de los pagos realizados, desglosados por concepto (Trabajador o Proveedor). Cada barra representa un pago individual, identificado por su servicio (descripción y destinatario). Los montos están expresados en MXN. Este análisis permite identificar los principales gastos y su distribución entre trabajadores y proveedores.</p>
          <div class="chart-container">
            <canvas id="pagosChart"></canvas>
          </div>
          <button class="update-button" onclick="generatePagosPDF()">Descargar PDF</button>
        `;
        renderPagosChart();
      }
    }

    async function renderPagosChart() {
      console.log('Renderizando gráfico de pagos...');
      const ctx = document.getElementById('pagosChart')?.getContext('2d');
      if (!ctx) {
        console.error('Contexto del canvas no encontrado');
        return;
      }
      if (pagosChart) {
        pagosChart.destroy();
      }
      const pagos = await fetchPagosData();
      if (pagos.length === 0) {
        console.log('No hay datos para el gráfico');
        ctx.canvas.parentNode.innerHTML = '<p>No hay datos de pagos disponibles.</p>';
        return;
      }
      const labels = pagos.map(pago => pago.servicio);
      const data = pagos.map(pago => parseFloat(pago.monto));
      const backgroundColors = pagos.map(pago => pago.concepto === 'Trabajador' ? 'rgba(54, 162, 235, 0.6)' : 'rgba(255, 99, 132, 0.6)');
      const borderColors = pagos.map(pago => pago.concepto === 'Trabajador' ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)');

      pagosChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Monto (MXN)',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Monto (MXN)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Servicio'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `$${context.raw.toLocaleString('es-MX')} MXN`;
                }
              }
            }
          }
        }
      });
      console.log('Gráfico de pagos renderizado');
    }

    async function searchProducts() {
      console.log('Buscando productos...');
      const query = document.getElementById('searchInput').value.trim();
      const resultsDiv = document.getElementById('searchResults');
      if (!resultsDiv) {
        console.error('Contenedor de resultados de búsqueda no encontrado');
        return;
      }
      if (query.length < 3) {
        resultsDiv.innerHTML = '';
        console.log('Consulta demasiado corta');
        return;
      }
      try {
        const response = await fetch(`/search?query=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const results = await response.json();
        console.log('Resultados de búsqueda:', results);
        if (results.length === 0) {
          resultsDiv.innerHTML = '<p>No se encontraron resultados.</p>';
          return;
        }
        resultsDiv.innerHTML = '<h3>Resultados de búsqueda:</h3><ul>' +
          results.map(item => `<li>${item.nombre} (${item.cantidad} unidades)</li>`).join('') +
          '</ul>';
      } catch (error) {
        console.error('Error en la búsqueda:', error);
        resultsDiv.innerHTML = '<p>Error al realizar la búsqueda.</p>';
      }
    }

    async function fetchStockData() {
      console.log('Obteniendo datos de stock...');
      try {
        const response = await fetch('/api/stock');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Datos de stock recibidos:', data);
        if (!data || data.length === 0) throw new Error('No hay datos de stock');
        return data.map(item => ({
          nombre: item.nombre || 'Producto desconocido',
          cantidad: Number(item.cantidad) || 0,
          imagen: item.imagen || 'https://via.placeholder.com/50'
        }));
      } catch (error) {
        console.error('Error al obtener datos de stock:', error);
        document.getElementById('stock-error').style.display = 'inline-block';
        return [
          { nombre: 'Producto A', cantidad: 100, imagen: 'https://via.placeholder.com/50' },
          { nombre: 'Producto B', cantidad: 200, imagen: 'https://via.placeholder.com/50' },
          { nombre: 'Producto C', cantidad: 50, imagen: 'https://via.placeholder.com/50' }
        ];
      }
    }

    async function renderProductsModal() {
      console.log('Renderizando modal de productos...');
      const productsGrid = document.getElementById('productsGrid');
      if (!productsGrid) {
        console.error('Contenedor de productos no encontrado');
        document.getElementById('productsError').style.display = 'inline-block';
        return;
      }
      const data = await fetchStockData();
      productsGrid.innerHTML = '';
      if (data.length === 0) {
        productsGrid.innerHTML = '<p>No hay productos disponibles.</p>';
        console.log('No hay productos para mostrar en modal');
        return;
      }
      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <img src="${item.imagen}" alt="${item.nombre}">
          <p class="product-name">${item.nombre}</p>
          <p class="product-percentage">${item.cantidad} unidades</p>
        `;
        productsGrid.appendChild(card);
      });
      console.log('Modal de productos renderizado con', data.length, 'elementos');
    }

    async function fetchTrabajadores() {
      console.log('Obteniendo datos de trabajadores...');
      try {
        const response = await fetch('/api/trabajadores');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Datos de trabajadores recibidos:', data);
        if (!data || data.length === 0) throw new Error('No hay datos de trabajadores');
        return data.map(item => ({ nombre: item.nombre || 'Trabajador desconocido' }));
      } catch (error) {
        console.error('Error al obtener datos de trabajadores:', error);
        return [
          { nombre: 'Juan Pérez' },
          { nombre: 'María López' },
          { nombre: 'Carlos Gómez' },
          { nombre: 'Ana Martínez' }
        ];
      }
    }

    async function fetchPagosData() {
      console.log('Obteniendo datos de pagos...');
      try {
        const response = await fetch('/api/pagos');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Datos de pagos recibidos:', data);
        if (!data || data.length === 0) throw new Error('No hay datos de pagos');
        return data;
      } catch (error) {
        console.error('Error al obtener datos de pagos:', error);
        return [
          { concepto: 'Trabajador', servicio: 'Salario (Juan Pérez)', monto: 10000 },
          { concepto: 'Proveedor', servicio: 'Suministros (Suministros Papel SA)', monto: 15000 },
          { concepto: 'Trabajador', servicio: 'Salario (María López)', monto: 12000 },
          { concepto: 'Proveedor', servicio: 'Transporte (Transportes Rápidos)', monto: 8000 }
        ];
      }
    }

    async function renderPagosTable() {
      console.log('Renderizando tabla de pagos...');
      const tbody = document.querySelector('#pagosTable tbody');
      if (!tbody) {
        console.error('Tbody de tabla no encontrado');
        return;
      }
      const pagos = await fetchPagosData();
      tbody.innerHTML = '';
      if (pagos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No hay pagos registrados.</td></tr>';
        console.log('No hay pagos para mostrar');
        return;
      }
      pagos.forEach(pago => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${pago.concepto}</td>
          <td>${pago.servicio}</td>
          <td>$${parseFloat(pago.monto).toLocaleString('es-MX')} MXN</td>
        `;
        tbody.appendChild(row);
      });
      console.log('Tabla de pagos renderizada con', pagos.length, 'filas');
    }

    function generateIngresosPDF() {
      console.log('Generando PDF de Ingresos...');
      const latexContent = `
\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage{geometry}
\\geometry{a4paper, margin=1in}
\\usepackage{booktabs}
\\usepackage{pdflscape}
\\usepackage{times}

\\begin{document}

\\begin{center}
  \\textbf{\\large Reporte de Ingresos} \\\\
  \\vspace{0.5cm}
  Papelera del Norte S.A. de C.V. \\\\
  Fecha: ${new Date().toLocaleDateString('es-MX')}
\\end{center}

\\section*{Resumen de Ingresos}
\\begin{tabular}{lr}
  \\toprule
  \\textbf{Concepto} & \\textbf{Monto (MXN)} \\\\
  \\midrule
  Total Ingresos & 150,000 \\\\
  Ingresos por Ventas & 120,000 \\\\
  Ingresos por Servicios & 30,000 \\\\
  \\bottomrule
\\end{tabular}

\\end{document}
      `;
      const blob = new Blob([latexContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Reporte_Ingresos.pdf';
      a.click();
      URL.revokeObjectURL(url);
      console.log('PDF de Ingresos generado');
    }

    function generateEgresosPDF() {
      console.log('Generando PDF de Egresos...');
      const latexContent = `
\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage{geometry}
\\geometry{a4paper, margin=1in}
\\usepackage{booktabs}
\\usepackage{pdflscape}
\\usepackage{times}

\\begin{document}

\\begin{center}
  \\textbf{\\large Reporte de Egresos} \\\\
  \\vspace{0.5cm}
  Papelera del Norte S.A. de C.V. \\\\
  Fecha: ${new Date().toLocaleDateString('es-MX')}
\\end{center}

\\section*{Resumen de Egresos}
\\begin{tabular}{lr}
  \\toprule
  \\textbf{Concepto} & \\textbf{Monto (MXN)} \\\\
  \\midrule
  Total Egresos & 80,000 \\\\
  Gastos Operativos & 50,000 \\\\
  Pagos a Proveedores & 30,000 \\\\
  \\bottomrule
\\end{tabular}

\\end{document}
      `;
      const blob = new Blob([latexContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Reporte_Egresos.pdf';
      a.click();
      URL.revokeObjectURL(url);
      console.log('PDF de Egresos generado');
    }

    async function generatePagosPDF() {
      console.log('Generando PDF de Pagos...');
      const pagos = await fetchPagosData();
      const tableRows = pagos.map(pago => 
        `${pago.concepto.replace(/&/g, '\\&')} & ${pago.servicio.replace(/&/g, '\\&')} & ${parseFloat(pago.monto).toLocaleString('es-MX')} \\\\`
      ).join('\n');
      const latexContent = `
\\documentclass{article}
\\usepackage[utf8]{inputenc}
\\usepackage{geometry}
\\geometry{a4paper, margin=1in}
\\usepackage{booktabs}
\\usepackage{pdflscape}
\\usepackage{times}

\\begin{document}

\\begin{center}
  \\textbf{\\large Reporte de Pagos} \\\\
  \\vspace{0.5cm}
  Papelera del Norte S.A. de C.V. \\\\
  Fecha: ${new Date().toLocaleDateString('es-MX')}
\\end{center}

\\section*{Resumen de Pagos}
\\begin{tabular}{llr}
  \\toprule
  \\textbf{Concepto} & \\textbf{Servicio} & \\textbf{Monto (MXN)} \\\\
  \\midrule
  ${tableRows}
  \\bottomrule
\\end{tabular}

\\end{document}
      `;
      const blob = new Blob([latexContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Reporte_Pagos.pdf';
      a.click();
      URL.revokeObjectURL(url);
      console.log('PDF de Pagos generado');
    }

    function logout() {
      console.log('Cerrando sesión...');
      window.location.href = 'bienvenida.html';
    }

    document.getElementById('welcomeModal')?.addEventListener('click', function(event) {
      if (event.target === this) closeModal();
    });

    document.getElementById('productsModal')?.addEventListener('click', function(event) {
      if (event.target === this) closeProductsModal();
    });

    document.getElementById('registrarEgresoModal')?.addEventListener('click', function(event) {
      if (event.target === this) closeRegistrarEgresoModal();
    });

    window.onload = initializePage;
  </script>
</body>
</html>